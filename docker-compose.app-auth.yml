# =============================================================================
# GitHub Runner - GitHub App Authentication Override
# =============================================================================
# Use this file when authenticating with a GitHub App instead of a PAT.
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.app-auth.yml up -d
#
# Or set COMPOSE_FILE in your environment:
#   export COMPOSE_FILE=docker-compose.yml:docker-compose.app-auth.yml
#
# APP_PRIVATE_KEY_FILE in .env = Host path to PEM file
# The entrypoint reads the file and sets APP_PRIVATE_KEY content automatically
# =============================================================================

services:
  agent:
    volumes:
      - tool-cache:/opt/hostedtoolcache
      # Mount host PEM file to container
      - ${APP_PRIVATE_KEY_FILE:-./github-app.pem}:/opt/github-app.pem:ro
    entrypoint: /bin/sh
    command:
      - -c
      - |
        export APP_PRIVATE_KEY="$$(cat /opt/github-app.pem)"
        exec /entrypoint.sh ./bin/Runner.Listener run --startuptype service
